<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>表单生成</title>
<script type="text/javascript" src="../syntax/scripts/shCore.js"></script>
<script type="text/javascript" src="../syntax/scripts/shBrushPhp.js"></script>
<link type="text/css" rel="stylesheet" href="../style/base.css" />
<link type="text/css" rel="stylesheet" href="../style/function.css" />
<link type="text/css" rel="stylesheet" href="../syntax/styles/shCoreDefault.css"/>
<script type="text/javascript" src="../treeview/base.js"></script>
<style type="text/css">
<!--
.STYLE1 {
	color: #0000FF;
	font-weight: bold;
}
-->
</style>
</head>

<body><pre><h2>表单的生成</h2>

<strong>一、生成表单</strong>
1、表单新建（自动验证）
      在Action类中，应该在registerForms()方法中新建表单，它是在__action()之前，display()和submit()之后执行。
      如果action不是独立成类，而是在控制器类中的方法函数，则要在返回前端或渲染页面之前手动生成。
             <span class="STYLE1">form(name)</span>
</pre>
<table>
	<tr class="head">
		<td width="90">名称</td>
		<td width="400">描述</td>
	</tr>
	<tr>
		<td>name</td>
		<td>必需。表单名称。</td>
	</tr>
</table>
<pre>

      以下示例action作为控制器的方法的：

<pre class="brush: php;">class CreateAction extends ItemController
{
    //初始化代码
	public function __action()
	{}
	
	//新建表单
    public function registerForms()
	{
		$this->form('form_item_edit') 
			->init(
			     ocUrl('/admin/item/edit'), 
				array(  //表单的其他属性设置
					'class' => 'form-edit', 
					'onchange' => 'reurn validateForm(this)'
				)
			);
	}
	
	//这里写页面显示前的逻辑...
	public function display()
	{}
	
	//这里写表单提交后的代码...
	public function submit()
	{}
}
	</pre>
<pre>
2、给表单绑定数据表模型
      用model()给表单绑定数据模型Model，可以对表单进行提交数据验证，还可在表单中使用表字段别名、多语言配置。
            <span class="STYLE1">model(class, alias) </span>
      参数说明：
</pre>
<table>
	<tr class="head">
		<td width="90">名称</td>
		<td width="400">描述</td>
	</tr>
	<tr>
		<td>class</td>
		<td>必需。数据模型的类名，需要命名空间格式。如：app\dal\models\Item</td>
	</tr>
	<tr>
		<td>alias</td>
		<td>必需。模型别名。当使用表单的lang()或map()方法时，可以使用“别名.字段名”格式</td>
	</tr>
</table>
<pre>
<pre class="brush: php;">class TestController extends Controller
{
	//控制器初始化代码
	public function __control()
	{}
	
	public function createAction()
	{
		//新建表单
		$this->form('form_item_edit') 
			->init(
				 ocUrl('/admin/item/edit'),
				array(
					'class' => 'form-edit',
					'onchange' => 'reurn validateForm(this)'
				)
			)
			->model('app\model\database\ItemModel', 'item'); //增加item表的字段验证规则

		//如果是POST提交，则进行表单填写校验
		if (Request::isPost()) {
	        //校验表单是否过期
			$this->checkForm();
			//表单字段验证
			$this->validator
				->addForm($this->form('form_item_edit'));
		} else {
		    //这里写页面显示前的代码
		}
	}
}</pre>

3、表单属性设置
      上例中可以看出对表单的属性进行设置是用表单的init()方法，格式如下：
            <span class="STYLE1">init([action, attributes]) </span>
      参数说明：
</pre>
<table>
	<tr class="head">
		<td width="90">名称</td>
		<td width="400">描述</td>
	</tr>
	<tr>
		<td>action</td>
		<td>可选。表单的action属性值。 默认为“#”，表示当前URL。</td>
	</tr>
	<tr>
		<td>attributes</td>
		<td>可选。表单属性关联数组，键名为属性名，键值为属性值。如果不指定属性，表单只会添加id或name两个属性。</td>
	</tr>
</table>
<pre>


<pre class="brush: php;">$action = ocUrl('/user/login');
$attributes = array(
 'onsubmit' => 'return validateLogin()'
);

$this->form('form_edit')->init($action, $attributes);
</pre>

4、让表单具有上传文件的功能
     表单上传文件，一般是加上enctype="multipart/form-data"属性值。
     您可以在上例中的init()中添加，还可以简单地使用<span class="STYLE1">upload()</span>方法，它会自动加上该属性。

<pre class="brush: php;">public function registerForms()
{
	$this->form('form_item_edit')
		->init(
			 ocUrl('/admin/item/edit'),
			array(
				'class' => 'form-edit',
				'onchange' => 'reurn validateForm(this)'
			)
		)
		->upload(); //设置上传文件
}</pre>

5、表单令牌
      默认的，表单都有一个表单令牌。请参考<a href="表单令牌.html"><strong>表单令牌</strong></a>

<strong>二、表单的显示</strong>
      一般不建议大家自己在HTML中直接去写&lt;form&gt;标签，因为这样无法自动生成表单令牌。
      显示表单要使用表单对象的<span class="STYLE1">begin()</span>方法，该方法生成&lt;form&gt;标签，并加上表单令牌的<hidden>标签，如果开启了表单令牌的话。
      （1）原生PHP模板
           如果模板使用原生的PHP代码，可以这样开始表单：
<pre class="brush: php;">&lt;?php echo $form_edit->begin();?&gt; </pre>
           或者，如果修改了PHP的short_open_tag为On的话，这样开始：
<pre class="brush: php;">&lt;?=$form_edit->begin()?&gt;</pre>
      （2）模板插件（如smarty）
           如果您的模板是smarty引擎，假设smarty设置的标签是&lt;{}&gt;，这样开始：
<pre class="brush: php;">&lt;{$form_edit->begin()}&gt;</pre>           其他的模板引擎插件类似。
           表单的结束，可以直接写<strong>“&lt;/form&gt;”</strong>，也可以使用<span class="STYLE1">end()</span>方法结束，这个无所谓。
           如下示例：
<pre class="brush: php;">&lt;?php echo $form_edit->end();?&gt; </pre>

<strong>三、表单提交后的处理</strong>
1、POST方式提交的表单处理
	如果action独立成类，表单提交后的处理代码，要在<span class="STYLE1">submit()</span>方法中写。如下示例：
<pre class="brush: php;">
namespace app\controller\item;

use app\model\entity\database\ItemEntity;

class CreateAction extends Controller
{
    //初始化代码
	public function __action()
	{}
	
	//这里新建表单
    public function registerForms()
	{
		$this->form('form_create')
			 ->init(ocUrl($this->getRoute()))
	         ->model('app\model\database\ItemModel', 'item');
	}
	
	//这里写页面显示前的逻辑...
	public function display()
	{}
	
	//表单提交后的处理
	public function submit()
	{
		$data = $this->request->getPost();

		//表单验证
	    $this->validator
			->addRule('token', 'unEmpty')
	 		->addForm($this->form('form_create')) //验证表单
			->validate($data);

		//保存
		$itemEntity = new ItemEntity();
		$itemEntity
			->data($data)
			->save();
	}
}
</pre>
        框架在判断表单是否已提交时默认使用request对象的isPost()判断，如果要自定义呢？
	只要在<span class="STYLE1">isSubmit()</span>中做修改判断就行了，需要返回true或false。示例如下：
<pre class="brush: php;">class CreateAction extends Controller
{
    //初始化代码
	public function __action()
	{}

	//这里新建表单
    public function registerForms()
	{}

	//这里写页面显示前的逻辑...
	public function display()
	{}

	//表单提交后的处理
	public function submit()
	{}

	public function isSubmit()
	{
		//手动判断表单是否提交
		return isset($_POST['submit']);
	}
}
</pre>
2、修改表单提交的方式
      我们一般提交数据使用POST，有时候可能会用其他的HTTP提交方式，比如说GET等。
      当然，一般不建议使用GET方式提交表单。这里只是以GET方式为例说明。
      （1）两种判断方式
              GET提交的情形比较少，这种方式提交后，后台要做表单是否提交的判断。有以下两种场景：
              （a）如果控制器动作是个类的话，需要添加它的isSubmit()方法检测是否是表单提交。
              （b）如果控制器动作只是所属控制器的一个方法的话，要在其代码中检测。
      （2）服务端处理时设置表单提交方式
              控制器动作类中判断表单是否提交的具体实现，分为两步：
              （a）使用<span class="STYLE1">submitMethod('get')</span>设置表单提交方式为GET方式；
              （b）设置表示表单提交的条件，比如检测是否用GET方式提交了submit的按钮：isset($_GET('submit'))。
      （3）怎样获取GET提交的数据
              那么，怎么获取提交来的数据呢？有两种方法：
              （a）使用request对象的<span class="STYLE1">getGet()</span>方法
              （b）使用控制器动作的<span class="STYLE1">getSubmitData()</span>方法，它不管是POST还是GET提交的都能区分。
      如果Action独立成类的话，如下示例：
<pre class="brush: php;">class CreateAction extends Controller
{
    //初始化代码
	public function __action()
	{}
	
	//这里新建表单
    public function registerForms()
	{}
	
	//这里写页面显示前的逻辑...
	public function display()
	{}
	
	//这里写表单提交后的代码...
	public function submit()
	{
		$itemModel = $this->model('app\dal\models\ItemModel', 'item');
		$item->data($this->getSubmitData()) //使用$this->request->getGet()也是可以的
			 ->save();
    }
	
	//是否是表单GET提交的判断
	public function isSubmit()
	{
	    //设置表单的提交方式是GET
	    $this->submitMethod('get');

	    //【必须】判断表单是否提交
	    return isset($GET['submit']);
	}
}
</pre>
      如果Action没有独立成类的话，如下示例：
<pre class="brush: php;">class Controller extends Module
{
    //控制器初始化代码
	public function __control()
	{}

	//这里新建表单
    public function CreateAction()
	{
		//设置表单的提交方式是GET
	    $this->submitMethod('get');

	    //【必须】判断表单是否提交
	    if (isset($GET['submit'])) {
			$itemModel = $this->model('app\dal\models\ItemModel', 'item');
      		$item->data($this->getSubmitData()) //使用$this->request->getGet()也是可以的
				 ->save();
		} else {
			//这里写页面显示前的逻辑...
		}
	}
}
</pre>

<strong>四、表单控件的生成和使用</strong>
      1、使用表单生成控件
            在Ocara框架中，表单控件的生成有以下三种方式：
               （1）在模板源代码中直接写控件的HTML代码。
               （2）在模板源代码中使用Ocara\Core\Html控件生成对象
               （3）在模板显示前使用Ocara\Core\Form表单对象，它组合了Html对象的方法。
           所有的控件生成方法函数，请参见<a href="表单控件的生成.html">表单控件的生成</a>。

      2、表单控制件的输出
            （1）使用element()获取表单控件

                   （a）在后台生成控件
<pre class="brush: php;">class CreateAction extends ItemController
{
    //初始化代码
	public function __action()
	{}

	//这里新建表单
    public function registerForms()
	{
		$this->form('form_create')->init(ocUrl($this->getRoute()));
	}

	public function display()
	{
		$this->form('form_create')->text('userName2');
	}
}
</pre>
                   （b）在模板中使用表单控件元素
<pre class="brush: php;">&lt;?=$form_create->element('userName2')?&gt;</pre>
            （2）直接在模板中显示控件
<pre class="brush: php;">&lt;?=$form_create->text('userName2')?&gt;</pre>
      3、字段文本的显示
          （1）单表字段显示
          使用表单的lang()方法，可以获取该字段的语言配置。如下实例：
<pre class="brush: php;">&lt;?=$form_create->lang('userName2')?&gt;</pre>
          （2）多表字段显示
          表单可以多次使用model()方法指定多个模型的字段。框架会使用array_merge()合并所有的字段文本。
          所以如果有重复的冲突，可以用“别名或类名.字段”来获取语言文本，如下实例：

<pre class="brush: php;">
	//$this->form('form_create')->model('app\dal\models\User')未指定Model的别名
	&lt;?=$form_create->lang('app\dal\models\User.userName2')?&gt;

	//$this->form('form_create')->model('app\dal\models\User', 'user')指定了Model的别名
	&lt;?=$form_create->lang('user.userName2')?&gt;
</pre>
      4、动态设置字段别名
          使用表单的map()方法，可以动态设置字段的别名。
<pre class="brush: php;">
//设置别名映射
$form_create->map('userName3', 'username');
</pre>
          在模板中获取字段别名时，如下实例：
<pre class="brush: php;">&lt;?=$form_create->map('userName3')?&gt;</pre>
          如果同上所述的多个Model的重复字段冲突，如下实例：
<pre class="brush: php;">
	//$this->form('form_create')->model('app\dal\models\User')未指定Model的别名
	&lt;?=$form_create->map('app\dal\models\User.userName3', 'username')?&gt;

	//$this->form('form_create')->model('app\dal\models\User', 'user')指定了Model的别名
	&lt;?=$form_create->map('user.userName3', 'username')?&gt;
</pre>

</pre>
</body>
</html>
