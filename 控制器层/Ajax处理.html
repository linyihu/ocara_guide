<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Ajax处理</title>
    <script type="text/javascript" src="../syntax/scripts/shCore.js"></script>
    <script type="text/javascript" src="../syntax/scripts/shBrushPhp.js"></script>
    <link type="text/css" rel="stylesheet" href="../style/base.css" />
    <link type="text/css" rel="stylesheet" href="../syntax/styles/shCoreDefault.css"/>
    <script type="text/javascript" src="../treeview/base.js"></script>
    <style type="text/css">
        <!--
        .STYLE1 {
            color: #0000FF;
            font-weight: bold;
        }
        -->
    </style>
</head>

<body><pre><h2>Ajax后台处理</h2>

<strong>1、如何返回Ajax数据?</strong>
    有以下情况：
    （1）如果控制器是API控制器ApiController、Rest控制器RestController等，即接口调用模式，那么返回数据本身就类似于AJAX。
<pre class="brush: php;">
namespace app\controller\User;

class BindBySingleAction extends Controller
{
    public function __action()
    {}

	/**
	 * 提交后处理
	 */
	public function submit()
	{
        $data = $this->request->getPost();

        $this->validator
            ->addRule('username', 'notEmpty')
            ->validate($data);

	    $result = SingleCallService::build()->getPhone($data['car_code_num']);
	    return $result;
    }
}
</pre>
    （2）如果控制器是普通的模板渲染模式的CommonController，也分两种：
        （a）如果Action动作是动作类，则在api()方法中返回数据即可。
        （b）如果Action动作是控制器中的一个方法函数，则在方法函数中直接return结果就行了，前提是本身就是Ajax提交的。

      （1）返回成功结果
            返回Ajax数据，可以使用控制器动作的ajaxReturn()方法。格式如下：
               <span class="STYLE1">ajaxReturn(data[, message])</span>
            参数说明：
</pre>
<table>
    <tr class="head">
        <td width="90">名称</td>
        <td width="400">描述</td>
    </tr>
    <tr>
        <td>data</td>
        <td>可选。要返回的数据。</td>
    </tr>
    <tr>
        <td>message</td>
        <td>可选。处理结果的文字描述，为空时默认为“success”。数组提示或字符串提示。如果是数组，格式为array(提示代码，提示消息键名或文字）</td>
    </tr>
</table>
<pre>
      （2）返回错误结果
              错误结果，直接用<span class="STYLE1">Ocara::services()->error->show()</span>即可，会自动检测是否是Ajax请求并返回Ajax结果。

      （3）设置返回的文档格式
              Ajax返回的文档格式，包括Json、XML和html格式。
              如果要设置Ajax文档格式，只要设置application/config/system.php中的$CONF['DEFAULT_AJAX_CONTENT_TYPE']即可。
<pre class="brush: php;">
$CONF['DEFAULT_AJAX_CONTENT_TYPE'] = 'json'; //默认Ajax返回文档类型
</pre>
              还可以自定义设置当前控制器动作的$_ajaxContentType属性，这里的优先级要高于$CONF['DEFAULT_AJAX_CONTENT_TYPE']。
<pre class="brush: php;">
class DelAction extends ItemController
{
    protected $_ajaxContentType = 'xml'; //当前动作返回的文档格式
｝
</pre>
      （4）默认返回的文档格式
             如果没有设置返回文档格式，框架默认返回Json格式。

<strong>2、Ajax提交的php代码写在哪里？</strong>
       Ajax后台的代码，直接写在Action类中的<span class="STYLE1">ajax()</span>方法函数中写就行了：
<pre class="brush: php;">
namespace modules\index\guestbook;

use modules\index\item\Controller;
use app\model\entity\database\ItemEntity;

class DelAction extends Controller
{

   public function __action()
   {
      //action公共代码
   }

   public function ajax()
   {
       //获取item_id
       $item_id = $this->request->getGet('item_id');

       if ($item_id){
            $model = ItemEntity::build()->select($item_id);
            if ($model->delete()) {
                //删除成功，返回success状态值
                $this->ajaxReturn();
            }
       } else {
            //删除失败，返回error状态值。
            //failed_delete是多语言设置的提示消息键名，需要在application/lang语言目录配置具体内容。
            $this->error->show('failed_delete');
       }
    }
}
</pre>
      上述是删除商品的例子，如果删除成功，会返回success状态，否则，会返回error状态和错误提示。

<strong>3、Ocara如何判断是不是Ajax提交?</strong>
          Ocara首先判断小写的$_SERVER['HTTP_X_REQUESTED_WITH']是否等于 'xmlhttprequest'。
          如果$_SERVER没有这个'HTTP_X_REQUESTED_WITH'选项。再判断是否带有参数oc_ajax，并且其值是否大于0，若大于0表示有Ajax提交。
所以此时，JS中必须在URL中传递大于0的oc_ajax参数。

</pre></body>
</html>
