<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Session处理</title>
<script type="text/javascript" src="../syntax/scripts/shCore.js"></script>
<script type="text/javascript" src="../syntax/scripts/shBrushPhp.js"></script>
<link type="text/css" rel="stylesheet" href="../style/base.css" />
<link type="text/css" rel="stylesheet" href="../style/function.css" />
<link type="text/css" rel="stylesheet" href="../syntax/styles/shCoreDefault.css"/>
<script type="text/javascript" src="../treeview/base.js"></script>
</head><body><pre><h2>Session保存方式</h2>

Ocara支持文件、数据库和缓存三种保存方式，也提供了session操作插件。

<strong>1、文件保存方式</strong>
      需要关闭数据库保存，并且自定义文件保存路径。
      比如要保存在cache/my_sessions
    （1）修改配置文件/application/config/system.php：
<pre class="brush: php;">/*
 * session配置
 */
$CONF['SESSION'] = array(
    'handler' => 'Ocara\Sessions\SessionFile',
    'options' => array(
        'save_time'	 => 0, //session的最长存活时间（单位为秒）
        'location'	 => 'sessions', //保存位置，文件目录名、数据库表名或缓存前缀
    ),
);</pre>
       说明：
            （a）选项“save_type”为1；
            （b）选项“location”为session的保存目录，默认是cache/sessions，上级目录规定是required/data。

<strong>2、数据库保存方式</strong>
      （1）新建session数据表
            添加好数据表，然后在开发者中心添加模型。
            该数据表应该至少包含3个字段
                  （a）当前Session会话的ID（别名session_id）
                  （b）当前Session会话有效期（别名session_expire_time）
                  （c）当前Session会话的数据（别名session_data）
            另外，建议增加添加时间create_time和最后修改时间modify_time两个字段，用于查询。
            比如，以下是Mysql中添加的数据表:

<pre class="brush: php;">
CREATE TABLE `sessions` (
  `id` int(11) unsigned not null comment '自增ID',
  `session_id` varchar(255) NOT NULL comment '当前Session会话的ID',
  `session_expire_time` datetime NOT NULL comment '当前Session会话有效期',
  `session_data` text NOT NULL comment '当前Session会话的数据',
  `create_time` int(11) unsigned NOT NULL comment '添加时间',
  `modify_time` int(11) unsigned NOT NULL comment '最后修改时间',
  PRIMARY KEY (`session_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8
</pre>
      （2）配置session为保存方式
            修改配置文件/application/config/system.php，比如我们新建了\app\model\database\Session模型：
<pre class="brush: php;">
/*
 * session配置
 */
$CONF['SESSION'] = array(
    'handler' => 'Ocara\Sessions\SessionDB',
    'options' => array(
        'save_time'	 => 0, //session的最长存活时间（单位为秒）
        'location'	 => '\Ocara\Service\app\model\database\Session', //保存处理类，默认为Session Model类
    ),
);</pre>      说明：
            （a）选项“save_time”为session的最长存活时间（单位为秒）；
            （b）选项“location”为session模型类名，默认为\Ocara\Service\app\model\database\Session
      （3）修改Model
            上述实例使用的是默认的session处理模型。
            如果想要修改，可以另外生成一个session模型，要继承接口Ocara\Service\Interfaces\Model。

<strong>3、缓存保存方式</strong>
      需要缓存支持。
      先要装好Memcache或Redis等缓存，然后在/application/config/cache.php配置好缓存选项。
      假设使用$CONF['CACHE']['cache_redis']的话，修改配置文件/application/config/system.php：
<pre class="brush: php;">
/*
 * session配置
 */
$CONF['SESSION'] = array(
    'handler' => 'Ocara\Sessions\SessionCache',
    'options' => array(
        'save_time'	 => 0, //session的最长存活时间（单位为秒）
        'server'     => 'cache_redis', //服务器名称，数据库服务器名称或Redis服务器名
        'location'	 => 'session:', //保存session的缓存前缀
    ),
);</pre>
      说明：
            （a）选项“save_time”为session的最长存活时间（单位为秒）；
            （b）选项“server”，即保存session的缓存服务器名称，这里使用cache_redis，默认为default；
            （c）选项“location”为保存session的缓存前缀，默认为session，框架会自动加上下划线。

<h2>Session操作方式</h2>

<strong>（1）直接用$_SESSION</strong>
    如：
<pre class="brush: php;">$login_info = $_SESSION['login_info'];</pre>
    或者，
<pre class="brush: php;">$login_info = ocGet('login_info', $_SESSION);</pre>
<strong>（2）使用插件Session（推荐）</strong>
     session操作请使用\Ocara\Core\Session，控制器动作中可以直接使用$this->session。该插件的方法函数介绍，请参见<a href="./Session操作.html" title="表单生成">Session操作</a>
     调用代码：
    （a）控制器中使用$this->session调用
	<pre class="brush: php;">
//在控制器中使用$this->session
$login_info = $this->session->get('login_info');
	</pre>
    （b）非控制器中使用ocService()->session调用
<pre class="brush: php;">
//在非控制器中使用ocService()->session
$login_info = ocService()->session->get('login_info');
</pre>

</pre>
</body></html>
