<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Session处理</title>
<script type="text/javascript" src="../syntax/scripts/shCore.js"></script>
<script type="text/javascript" src="../syntax/scripts/shBrushPhp.js"></script>
<link type="text/css" rel="stylesheet" href="../style/base.css" />
<link type="text/css" rel="stylesheet" href="../style/function.css" />
<link type="text/css" rel="stylesheet" href="../syntax/styles/shCoreDefault.css"/>
<script type="text/javascript" src="../treeview/base.js"></script>
</head><body><pre><h2>Session保存方式</h2>

Ocara支持文件、数据库和缓存三种保存方式，也提供了session操作插件。

<strong>1、文件保存方式</strong>
      需要关闭数据库保存，并且自定义文件保存路径。
      比如要保存在cache/my_sessions
    （1）修改配置文件/required/conf/develop.php：
<pre class="brush: php;">/*
 * session配置
 */
$CONF['SESSION'] = array(
	'save_type'	 => 1, //session保存方式，1为自定义文件类型，2为数据库类型，3为缓存类型
	'save_time'	 => 0, //session的最长存活时间（单位为秒）
	'server'     => '', //服务器名称，因为是文件保存方式，所以这里为空即可
	'location'	 => 'cache/sessions', //保存session的文件目录名
);</pre>
       说明：
            （a）配置项“save_type”为1；
            （b）配置项“location”为session的保存目录，默认是cache/sessions，上级目录规定是required/data。

<strong>2、数据库保存方式</strong>
      （1）新建session数据表
            添加好数据表，然后在开发者中心添加模型。
            该数据表应该至少包含3个字段
                  （a）当前Session会话的ID（别名session_id）
                  （b）当前Session会话有效期（别名session_expire_time）
                  （c）当前Session会话的数据（别名session_data）
            另外，建议增加添加时间create_time和最后修改时间modify_time两个字段，用于查询。
            比如，以下是Mysql中添加的数据表:
<pre class="brush: php;">

CREATE TABLE `ocsess` (
  `ocsess_id` char(100) NOT NULL comment '当前Session会话的ID',
  `ocsess_expire_time` datetime NOT NULL comment '当前Session会话有效期',
  `ocsess_data` longtext NOT NULL comment '当前Session会话的数据',
  `create_time` int(11) unsigned NOT NULL comment '添加时间',
  `modify_time` int(11) unsigned NOT NULL comment '最后修改时间',
  PRIMARY KEY (`ocsess_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8
</pre>
      （2）添加session模型
	在开发者中心添加session模型，然后框架会在resource/conf/model下面新建了该模型的模型配置文件。
	在模型配置文件中修改$CONF['MAP']，添加别名映射。
<pre class="brush: php;">
/**
 * 字段别名映射
 */
$CONF['MAP'] = array(
    'session_id' => 'ocsess_id',
    'session_expire_time' => 'ocsess_expire_time',
    'session_data' => 'ocsess_data',
);
</pre>
      （3）配置session为保存方式
            修改配置文件/required/conf/develop.php，比如我们新建了\Model\Session模型：
<pre class="brush: php;">
/*
 * session配置
 */
$CONF['SESSION'] = array(
	'save_type'	 => 2, //session保存方式，1为自定义文件类型，2为数据库类型，3为缓存类型
	'save_time'	 => 0, //session的最长存活时间（单位为秒）
	'server'     => '', //服务器名称，因为location已指定Model，所以这里为空即可
	'location'	 => '\Model\Session', //Model类
);</pre>      说明：
            （a）配置项“save_type”设为2；；
            （b）配置项“location”为保存session的数据表名，默认为ocsess
      （4）修改Model
            通过在开发者中心中添加session模型。然后修改文件内容。
            添加以下四个方法：
                  （a）read($sessionId)，主要是读取指定session_id的session数据。
                  （b）write($data)，主要是写入指定的session数据。
                  （c）destroy($id)，释放指定的session数据，即删除此行记录。
                  （d）clear()，清理过期的session记录。
            以下是当前实例代码：
<pre class="brush: php;">
<?php
namespace Model;
use Ocara\Model\Database;

class Session extends Database
{
	protected $_table = 'ocsess';
	protected $_primary = 'ocsess_id';

	/**
	 * 初始化模型
	 */
	protected function _model()
	{}

	/**
	 * 读取session
	 * @param $sessionId
	 * @return null
	 */
	public function read($sessionId)
	{
		$where = array('session_id' => $sessionId);

		$result = $this
			->where($where)
			->findFirst();

		return $result ? $result['session_data'] : null;
	}

	/**
	 * 写入session
	 * @param $data
	 */
	public function write($data)
	{
		$where = array(
			'session_id' => $data['session_id']
		);

		$sessionInfo = $this->findFirst($where);
		if ($sessionInfo) {
			$data['modify_time'] = time();
			$this->where($where)->update($data);
		} else {
			$data['create_time'] = time();
			$data['modify_time'] = time();
			$this->create($data);
		}
	}

	/**
	 * 删除session
	 * @param $sessionId
	 */
	public function destroy($sessionId)
	{
		$where = array(
			'session_id' => $sessionId
		);

		$sessionInfo = $this->findFirst($where);
		if ($sessionInfo) {
			$this->select($sessionInfo['id'])->delete();
		}
	}

	/**
	 * 清理过期session
	 */
	public function gc()
	{
		$where = array(
			'session_expire_time' => date(ocConfig('DATE_FORMAT.datetime'))
		);

		$this->cWhere('<', $where)->delete();
	}
}
</pre>
<strong>3、缓存保存方式</strong>
      需要缓存支持。
      先要装好Memcache或Redis等缓存，然后在/required/conf/cache.php配置好缓存选项。
      假设使用$CONF['CACHE']['cache_redis']的话，修改配置文件/required/conf/develop.php：
<pre class="brush: php;">
/*
 * session配置
 */
$CONF['SESSION'] = array(
	'save_type'	 => 3, //session保存方式，1为自定义文件类型，2为数据库类型，3为缓存类型
	'save_time'	 => 0, //session的最长存活时间（单位为秒）
	'server'     => 'cache_redis', //服务器名称，数据库服务器名称或Redis服务器名
	'location'	 => 'sessions', //保存session的缓存前缀，缓存前缀
);</pre>
      说明：
            （a）配置项“save_type”设为3；
            （b）配置项“server”，即保存session的缓存服务器名称，这里使用cache_redis，默认为default；
            （c）配置项“location”为保存session的缓存前缀，默认为sessions


<h2>Session操作方式</h2>

<strong>（1）直接用$_SESSION</strong>
    如：
<pre class="brush: php;">$login_info = $_SESSION['login_info'];</pre>
    或者，
<pre class="brush: php;">$login_info = ocGet('login_info', $_SESSION);</pre>
<strong>（2）使用插件Session（推荐）</strong>
     session操作请使用\Ocara\Session，控制器动作中可以直接使用$this->session。该插件的方法函数介绍，请参见<a href="./Session操作.html" title="表单生成">Session操作</a>
     调用代码：
    （a）模块、控制器或动作action的代码中可以使用$this->session调用，如：
	<pre class="brush: php;">
$login_info = $this->session->get('login_info'); 
	</pre>
    （b）静态调用方式
<pre class="brush: php;">
$login_info = Session::get('login_info');
</pre>

</pre>
</body></html>
