<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>静态生成</title>
<script type="text/javascript" src="../syntax/scripts/shCore.js"></script>
<script type="text/javascript" src="../syntax/scripts/shBrushPhp.js"></script>
<link type="text/css" rel="stylesheet" href="../style/base.css" />
<link type="text/css" rel="stylesheet" href="../style/function.css" />
<link type="text/css" rel="stylesheet" href="../syntax/styles/shCoreDefault.css"/>
<script type="text/javascript" src="../treeview/base.js"></script>
</head>
<body>
<pre><h2>静态生成</h2>

<strong>一、什么是静态生成</strong>
       在网站应用中，有的页面内容不是经常改变，我们为了使访问速度更快，往往可以将它生成一个静态的html文件，不需要每次都要去动态运行再
输出html，这样也能减少服务器负载。所以，<strong>将不是经常修改的动态文件执行结果（如asp，php或jsp文件）生成静态的html文件，用户访问时只要快
速地访问这个静态页面，来提高访问速度，就是静态生成。</strong>

<strong>二、静态生成的步骤</strong>
       Ocara静态生成很简单。
       只需三步:
             （1）配置静态生成的URL路由格式；
             （2）通过回调函数或路由，返回要静态生成的MVC路由和参数；
             （3）调用生成函数生成静态页面。

<strong>1、配置URL路由格式</strong>
       静态生成，不是全站都要静态生成，所以，我们在做静态生成时，要确定哪些页面要静态生成。
       我们需要在required/conf/static.php中进行静态生成的配置。
       静态配置分成route、map和params三项，分别是$CONF['STATIC']的三个数组键。
（1）配置路由格式
         配置项是$CONF['STATIC']['route']。
         说明：
              {c}代表控制器，{a}代表动作，{p}表示其他参数。
              分隔符只能是下划线"-"和顺斜杠"/"。
         具体实例：
                实例1，假设路由格式为http://域名/控制器/动作/其他参数，配置如下：
<pre class="brush: php;">$CONF['STATIC']['route'] = '{c}/{a}/{p}';</pre>                实例2,，假设路由格式为http://域名/控制器/动作-其他参数，配置如下：
<pre class="brush: php;">$CONF['STATIC']['route'] = '{c}/{a}-{p}';</pre>             
</pre><table class="hint">
	<tr class="head">
		<td><h2>注意：</h2>模块是不需要配置的，因为模块是强制使用顺斜杠"/"将其与后面的参数分隔的。</td>
	</tr>
</table>
<pre>
（2）配置URL的查询字符串参数格式
         配置项是$CONF['STATIC']['params']，是多维数组。
         说明：
             （a）模块、控制器和动作参数都作为数组键名。
             （b）其他的参数字段都要用花括号括起来。并且以斜杠"/"或英文横杠“-”等分隔。
                       （a1）“/”为目录分隔符
                                 也就是说其左边参数字符串会作为要保存的目录名称。 比如，若配置成&quot;{id}/{fid}-{tid}&quot;，那么生成静态时会将静态文件保存到id字段命名的目录中。
                       （a2）”-“为参数分隔符（可修改）
                                 如果不想用“-”而希望使用别的分隔符，则可以配置<span class="brush: php;">$CONF['STATIC']['</span>delimiter<span class="brush: php;">']选项</span>。 比如以下划线“_”分隔，如下所示：
<pre class="brush: php;">$CONF['STATIC']['delimiter'] = '_';  </pre>
         具体实例，假设上面的路由格式配置为'{c}/{a}-{p}'，有如下参数配置：
		 
<pre class="brush: php;">$CONF['STATIC']['params'] = array(
	//前台论坛帖子控制器
	'thread' => array(
		'index'   => '{id}-{fid}-{tid}', //参数格式会是：id-fid-tid，访问地址会是http://域名/home/index-1-2-25.html
		'read'    => '{id}-{fid}'				//参数格式会是：id-fid，访问地址会是http://域名//home/read-1-2.html
	),
	//论坛会员中心模块ucenter
	'ucenter' => array(
        //我的回帖
		'repost' => array(            
			'list'=> '{fid}/{tid}'  //参数格式会是：tid，静态页面访问地址会是http://域名/bbs/thread/read/12/2.html
		),
        //我的帖子
		'thread' => array(        
			'list' => '{fid}' //参数格式会是：fid-tid，，静态页面访问地址会是http://域名/bbs/forum/list-2.html
		)
	)
);
</pre>
<strong>2、回调函数、类方法或路由</strong>
      回调，主要是用来指定要静态生成的MVC路由和参数的数据。
      如上已经配置了路由格式和参数格式，那么哪些具体的页面要生成呢。
      比如我们的bbs/thread/read表示论坛版块阅读页面，那么具体是哪些论坛版块ID的阅读页面呢？
      这时候，就要用到回调。 
      下面就介绍一下回调函数、类方法或者MVC路由。
     （1）函数回调
            使用getHtmlData函数回调。
            比如上例，如果thread是数据表名并且几个参数都是数据库字段原名的话，代码简单多了：
<pre class="brush: php;">function getHtmlData($module, $controller, $action, $params)
{
     if ($controller == 'thread') {
           if ($action == 'list')  {
                 //从数据库中查询路由
                $class = '\Model\\' . $controller;
          		 $model = new $class();
                 $fields = implode(',', $params);
                 return $model-&gt;fields($fields)-&gt;getAll();
            } elseif ($action == 'read') {
                 //read动作的代码
            }
     } else {
           //其他代码
     }

 	 return array();
}
</pre>
            否则，<strong>假设某个参数不是字段原名，则需要注意返回结果中要包含该参数。</strong>
            比如fid参数是forum_id字段的别名：
<pre class="brush: php;">function getHtmlData($module, $controller, $action, $params)
 {
	 if ($controller == 'thread') {
           if ($action == 'list')  {
                 //从数据库中查询路由
                 $class = '\Model\\' . $controller;
                 $model = new $class();
                 //字段名处理
                 foreach ($params as $key =&gt; $field) {
                       if ($field == 'fid') {
                             $params[$key] = 'forum_id AS fid';
                       }
                 }
                 $fields = implode(',', $params);
                 return $model->fields($fields)->getAll();
            } elseif  ($action == 'read')  {
                 //read动作的代码
            } 
     } else {
           //其他代码
     }

 	 return array();
}

</pre>
      （2）类方法回调
          使用StaticCallBack类的getHtmlData方法回调。
<pre class="brush: php;">class StaticCallBack 
{
　　  public function getHtmlData($module, $controller, $action, $params)
     {
           //代码同上
     }
}
</pre>
      （3）动作回调
          使用static控制器的gethtmldata动作回调。
          （a）使用控制动作类
                   使用动作类时，回调要写在_action中。
<pre class="brush: php;">class GethtmldataAction extends StaticController 
{
　　 protected function _action($module, $controller, $action, $params)
	 {
      	 //代码同上
 	 }
}
</pre>
          （b）直接写在控制器中
<pre class="brush: php;">class StaticController extends Controller 
{
　　 public function gethtmldataAction($module, $controller, $action, $params)
	{
      	//代码同上
 	}
}
</pre>


<strong>3、生成静态</strong>
      通过以上两步，配置并写好了回调函数，下面我们只要调用生成函数，就能生成静态了。
<strong>（1）目录权限</strong>
      请保证生成的目录public/static有可写权限，生成的静态页面都是在该目录下面。
	  
<strong>（2）生成静态</strong>
      生成函数，就是使用系统插件StaticBuilder的genAll()方法，格式如下：
            <span class="function"><strong>genAll(callback)</strong></span>
      参数说明：
          
<table>
    <tr class="head">
        <td width="90">名称</td>
        <td width="400">描述</td>
    </tr>
        <tr>
        <td>callback</td>
        <td>必需。回调函数、类的方法函数或MVC路由</td>
    </tr>
</table>  
      callback传递的参数值有三种：
      （a）回调函数
              如果是一个函数getHtmldata：
<pre class="brush: php;">$static->genAll('getHtmldata');</pre>
      （b）回调类方法
              如果是StaticCallback的getHtmldata方法：
<pre class="brush: php;">$static->genAll('StaticCallback::getHtmldata');</pre>
      （c）回调控制器/动作
              如果是一个static控制器的动作gethtmldata(控制器/动作)：
<pre class="brush: php;">$static->genAll('static/gethtmldata')):</pre>
              如果是一个是模块bbs的html控制器的动作gethtmldata：
<pre class="brush: php;">$static->genAll('bbs/static/gethtmldata');</pre>

<strong>（3）实例</strong>
      比如，以下是一个静态生成的控制器类，调用的是一个回调函数getHtmldata：
<pre class="brush: php;">class staticGenerateController extends Controller
{
    public function actionGenerate()
	{
        $static = new StaticBuilder();
        $static->genAll('getHtmldata');    
    }
}
</pre>
</pre>
</body></html>
