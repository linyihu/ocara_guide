<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>关联模型操作</title>
<script type="text/javascript" src="../syntax/scripts/shCore.js"></script>
<script type="text/javascript" src="../syntax/scripts/shBrushPhp.js"></script>
<link type="text/css" rel="stylesheet" href="../style/base.css" />
<link type="text/css" rel="stylesheet" href="../syntax/styles/shCoreDefault.css"/>
<script type="text/javascript" src="../treeview/base.js"></script>
</head>

<body><pre><h2>关联模型</h2>
<pre>

<strong>1、关联配置</strong>
    关联配置的选项，一般是在application/config/model中的数据表模型配置文件中的$CONF['JOIN']。

<pre class="brush: php;">
/**
 * 表关联
 */
'JOIN' => array(
    'userVerify' => array(
        'hasOne', '\app\dal\models\UserVerify', 'user_id', array('verify_status' => 2)
    ),
),
</pre>
      详细说明：
            （1）关联配置的键名userVerify为关联名，在使用时用于代替类名。
            （2）配置数组中有4个参数，分别介绍如下：
                  （a）hasOne，是关系类型，一般包括一对一（hasOne）、一对多（hasMany）、多对一（belongsTo）。
                  （b）\app\dal\models\UserVerify，是模型类名。必需是命名空间，并且第一位必须是带根命名空间“\”。
                  （c）user_id, 是关联字段。如果关联的两个表都是同一个字段，可以写成一个字段。如果是两个字段，只要用英文逗号分开，比如：'user_id, uid'。
                  （d）array('verify_status' => 2)，是附加的关联条件数组。
                          这里是verify_status操作，如果是其他操作符，则将值设为数组，比如in条件：array('verify_status' =>array('in', array(1, 3)))

<strong>2、使用关联ORM模型</strong>
            使用主表的时候，也可以使用它的关联表模型。
            一般是通过调用与关联名同名的关联属性来调用关联模型的，如$user->userVerify。

<pre class="brush: php;">
//查询user表
$user = \app\model\entity\database\UserEntity::build()->select1);

//使用userVerify关联表的字段
$verifyStatus = $user->userVerify->verify_status;

echo $verifyStatus;
</pre>
            对于不同的关系类型，关联属性返回值也不同，如下详细说明：
            （1）一对一（hasOne）和多对一（belongsTo）
                    关联属性返回的是该关联表的数据模型类，如上述实例。
            （2）一对多（hasMany）
                    关联属性返回的是一个PHP迭代器，可以使用foreach进行遍历。
                    每个元素就是一个该关联表的数据模型类，表示某一条关联记录。

<pre class="brush: php;">
//查询user表
$users = \app\model\entity\database\UserEntity::build()->select11);

//遍历关联模型
foreach ($users->userVerify as $row) {
   echo $row->verify_id . ' status : ' .$row->verify_status . '<br/>';
}
</pre>
<pre>
<strong>3、保存关联模型数据</strong>
            在保存主表的数据时，可以使用关联模型的ORM设置数据，框架会自动使用事务一起保存。
            （1）添加数据
                    在添加主表的数据时，可以添加关联模型数据。
                    对于不同的关系类型，关联属性也要设置不同的值类型，如下详细说明：
                    （a）一对一（hasOne）和多对一（belongsTo）
                            关联属性要设置关联模型类对象，表示一条记录。

<pre class="brush: php;">
//新建主表模型
$user= new \app\dal\models\User();

//设置当前user表的字段值
$user->user_name = 'user1'; //获取主键为1的记录数据
$user->email = 'newEmail@163.com'; //修改email

//设置user_verify表的字段数据
$user->userVerify = new \app\dal\models\UserVefiy();
$user->userVerify->verify_status = 1;
$user->userVerify->create_time = time();

/**
 * 一起保存到数据库
 * user和userVerify会自动保存，userVerify的user_id自动保存为user表的user_id
 */
$user->save(); //保存记录
</pre>
                    （b）一对多（hasMany）
                            关联属性要设置为关联模型对象数组，表示多条记录。
                            另外，如果当前只保存一条记录，关联属性也可以不用数组，直接用关联模型对象。
                            假设配置了一个user_money表的hasMany关系，如下配置代码：
<pre class="brush: php;">
/**
 * 表关联
 */
$CONF['JOIN'] = array(
    'userVerify' => array(
        'hasOne', '\app\dal\models\UserVerify', 'user_id', array('verify_status' => 2)
    ),
    'userMoney' => array(
        'hasMany', '\app\dal\models\UserMoney', 'user_id'
    ),
);
</pre>
                            然后，就可以添加记录，如下代码：

<pre class="brush: php;">
//新建主表模型
$user= new \app\dal\models\User();

//设置当前user表的字段值
$user->user_name = 'user1'; //获取主键为1的记录数据
$user->email = 'newEmail@163.com'; //修改email

//设置user_money表数据
$userMoney = array();

$moneyRow = new \app\dal\models\UserVerify();
$moneyRow->type = 1;
$moneyRow->money = 100;
$moneyRow->create_time = time();
$userMoney[] = $moneyRow;

$moneyRow2 = new \app\dal\models\UserVerify();
$moneyRow2->type = 2;
$moneyRow2->money = -100;
$moneyRow2->create_time = time();
$userMoney[] = $moneyRow2;

//绑定到user模型
$user->userMoney = $userMoney;

/**
 * 一起保存到数据库
 * user和userMoney会自动保存，userVerify的user_id自动保存为user表的user_id
 */
$user->save(); //保存记录

</pre>
    如果只保存一行关联模型记录，则可以不用数组：
<pre class="brush: php;">
//新建主表模型
$user= new \app\dal\models\User();

//设置当前user表的字段值
$user->user_name = 'user1'; //获取主键为1的记录数据
$user->email = 'newEmail@163.com'; //修改email

//设置user_money表数据
$moneyRow = new \app\dal\models\UserVerify();
$moneyRow->type = 1;
$moneyRow->money = 100;
$moneyRow->create_time = time();
$userMoney[] = $moneyRow;

//绑定到user模型
$user->userMoney = $moneyRow;

/**
 * 一起保存到数据库
 * user和userMoney会自动保存，userVerify的user_id自动保存为user表的user_id
 */
$user->save(); //保存记录

</pre>
            （2）更新数据
                    更新主表数据时，可以参照上面的第2点，直接使用关联属性。
                    （a）一对一（hasOne）和多对一（belongsTo）
                            更新时，直接使用关联属性。
<pre class="brush: php;">
//选择主表记录
$user = \app\model\entity\database\UserEntity::build()->select1);

//修改当前user表的字段值
$user->user_name = 'user1'; //获取主键为1的记录数据
$user->email = 'newEmail@163.com'; //修改email

//修改user_verify表的字段数据
$user->userVerify->verify_status = 1;
$user->userVerify->create_time = time();

/**
 * 一起保存到数据库
 */
$user->save(); //保存记录
</pre>
                    另外，如果关联表数据没有添加过，则还是要新建一个关联模型。如下实例：

<pre class="brush: php;">
//选择主表记录
$user = \app\model\entity\database\UserEntity::build()->select1);

//修改当前user表的字段值
$user->user_name = 'user1'; //获取主键为1的记录数据
$user->email = 'newEmail@163.com'; //修改email

//修改user_verify表的字段数据
$userVerify = new \app\model\database\userVerify();
$userVerify->verify_status = 1;
$userVerify->create_time = time();

//绑定到user模型
$user->userVerify = $userVerify;

/**
 * 一起保存到数据库
 * user和userVerify会自动保存，userVerify的user_id自动保存为user表的user_id
 */
$user->save(); //保存记录
</pre>
                    （b）一对多（hasMany）
                            更新时，要遍历关联属性，因为它是一个迭代器。
<pre class="brush: php;">
$user = \app\model\entity\database\UserEntity::build()->select1);

//主表字段设置
$user->user_name = 'user1'; //获取主键为1的记录数据
$user->email = 'newEmail@163.com'; //修改email

//关联表遍历设置
foreach ($user->userMoney as $row) {
    $row->modify_time = time();
}

/**
 * 一起保存到数据库
 */
$user->save(); //保存记录
</pre>
                            另外，如果关联表数据没有添加过，也需要添加数据。
                            同上第（2）(b）点实例配置，如下更新数据实例：

<pre class="brush: php;">
//选择主表记录
$user = \app\model\entity\database\UserEntity::build()->select1);

//主表字段设置
$user->user_name = 'user1'; //获取主键为1的记录数据
$user->email = 'newEmail@163.com'; //修改email

//设置关联表user_money表的字段数据
$userMoney = array();

$moneyRow = new \app\dal\models\UserVefiy();
$moneyRow->type = 1;
$moneyRow->money = 100;
$moneyRow->create_time = time();
$userMoney[] = $moneyRow;

$moneyRow2 = new \app\dal\models\UserVefiy();
$moneyRow2->type = 2;
$moneyRow2->money = -100;
$moneyRow2->create_time = time();
$userMoney[] = $moneyRow2;

//绑定到user模型
$user->userMoney = $userMoney;

/**
 * 一起保存到数据库
 * user和userMoney会自动保存，userVerify的user_id自动保存为user表的user_id
 */
$user->save(); //保存记录
</pre>

</pre>
</body>
</html>
