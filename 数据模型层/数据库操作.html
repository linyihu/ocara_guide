<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>数据库操作</title>
<script type="text/javascript" src="../syntax/scripts/shCore.js"></script>
<script type="text/javascript" src="../syntax/scripts/shBrushPhp.js"></script>
<link type="text/css" rel="stylesheet" href="../style/base.css" />
<link type="text/css" rel="stylesheet" href="../syntax/styles/shCoreDefault.css"/>
<script type="text/javascript" src="../treeview/base.js"></script>
<style type="text/css">
<!--
.STYLE3 {color: #0000FF; font-weight: bold; }
-->
</style>
</head>

<body><pre><h2>数据操作</h2>

<strong>1、添加记录</strong>
            （1）使用save()方法
                只要Model未设置查询条件，使用ORM模型的save()都是添加记录。

                    （a）使用POST数据【data()方法不传参数】
<pre class="brush: php;">
$userModel = new \app\dal\models\User();

$userModel->data(); //建立ORM模型，获取POST提交的数据

$userModel->status = 0;
$userModel->create_time = time();

$extraData = array(
	'update_time' => time()
);

//保存记录
$userModel->save($extraData);
</pre>
                    （b）指定数组的数据记录
<pre class="brush: php;">
$userModel = new \app\dal\models\User();

//新建数据数组
$data = array(
  'user_name' => ocService()->request->getPost('userName'),
  'email'  => 'test@163.com',  //手动指定的
);


$userModel->data($data); //建立ORM模型
$userModel->status = 0;
$userModel->create_time = time();

$extraData = array(
	'update_time' => time()
);

//保存数据
$userModel->save($extraData);
</pre>
            （2）使用create()方法
                    使用Model的create()方法也可以添加记录，格式如下：
                        <span class="STYLE3">create([data, debug])</span>
                    参数说明：
</pre>
<table>
	<tr class="head">
		<td width="90">名称</td>
		<td width="400">描述</td>
	</tr>
	<tr>
		<td>data</td>
		<td>可选。如果为空，自动获取POST提交的数据。必须是关联数组。
		键名为字段名或<a href="字段别名.html">字段别名</a>。<br/>
		如果键名与表的字段名称或别名相同，则这条键值数据会保存，否则被忽略。
	    </td>
	</tr>
	<tr>
		<td>debug</td>
		<td>可选。用于SQL语句调试，参见<a href="数据库查询.html">数据查询</a>中的主键查询方法select()的debug参数。</td>
	</tr>
</table>
<pre>


                    （a）使用POST数据
<pre class="brush: php;">
//添加记录
$userModel = new \app\dal\models\User();
$userModel->create();
</pre>
                    （b）指定数组的数据记录
<pre class="brush: php;">//新建数据数组
$data = array(
  'user_name' => ocService()->request->getPost('userName'),
  'email'  => ocService()->request->getPost('email'),  //手动指定的
  'status' => 0,
  'create_time' => time()
);

//添加记录
$userModel = new \app\dal\models\User();
$userModel->create($data);
</pre>

<strong>2、更新记录</strong>
        （1）单记录更新【使用ORM模型】
                使用select()选择记录，再使用data()设置修改数据，最后使用save()方法保存.

                （a）获取POST数据【data()方法不传参数】
<pre class="brush: php;">
$userModel = new \app\dal\models\User();

//选择主键ID为1的记录，建立ORM模型
$userModel = \app\dal\models\User::select(1);
$userModel->update_time = time();

//设置POST提交的数据
$userModel->data();

$extraData = array(
	'update_time' => time()
);

//保存记录

//1.使用save()
//$userModel->save($extraData);
//2.使用update()
//$userModel->update($extraData);
</pre>
                （b）指定数据数组
<pre class="brush: php;">
//选择主键ID为1的记录，建立ORM模型
$userModel = \app\dal\models\User::select(1);
$userModel->update_time = time();

//指定数据数组
$data = array(
  'user_name' => ocService()->request->getPost('test'),
  'email'  => 'test@163.com',  //手动指定的
);
$userModel->data($data);

$extraData = array(
	'update_time' => time()
);

//更新记录

//1.使用save()
//$userModel->save($extraData);

//2.使用update()
//$userModel->update($extraData);
</pre>
        （2）批量更新【使用update()】
                先使用where()等等设置条件，再使用update()方法更新数据，格式如下：
                        <span class="STYLE3">update([data, debug])</span>
                参数说明：
</pre>
<table>
	<tr class="head">
		<td width="90">名称</td>
		<td width="400">描述</td>
	</tr>
	<tr>
		<td>data</td>
		<td>可选。同上。</td>
	</tr>
	<tr>
		<td>debug</td>
		<td>可选。同上。</td>
	</tr>
</table>
<pre>


                （a）获取POST数据
<pre class="brush: php;">
$userModel = new \app\dal\models\User();

//设置条件
$where = array(
	'user_id' => 1
);
$userModel->where($where);

//更新记录，未指定第一个参数data，则保存POST提交的数据
$userModel->update();
</pre>
                （b）指定数据数组
<pre class="brush: php;">
$userModel = new \app\dal\models\User();

//设置条件
$where = array(
	'user_id' => 1
);
$userModel->where($where);

//新建数据数组
$data = array(
  'user_name' => ocService()->request->getPost('test'),
  'email'  => 'test@163.com',  //手动指定的
  'update_time' => time()
);

//更新记录，传递第一个参数data，指定数据
$userModel->update($data);
</pre>

<strong>3、删除记录</strong>
        更新记录必须先设置条件，然后使用delete()方法删除记录，格式如下：
            <span class="STYLE3">delete([debug])</span>
        参数说明：
</pre>
<table>
	<tr class="head">
		<td width="90">名称</td>
		<td width="400">描述</td>
	</tr>
	<tr>
		<td>debug</td>
		<td>可选。同上。</td>
	</tr>
</table>
<pre>


        （a）使用ORM模型
<pre class="brush: php;">
$userModel = \app\dal\models\User::select(1);
$userModel->delete();
</pre>
        （b）使用条件where()等批量更新
<pre class="brush: php;">
$userModel = new \app\dal\models\User();
$where = array(
	'status' => 1
);

//删除记录
$userModel->where($where)
               ->delete();
</pre>

 <strong>4、ORM模型下的事件回调</strong>
	当使用ORM模型进行数据操作时，可以使用以下方法事件。
    （1）添加记录事件
	使用beforeCreate()和afterCreate()方法处理添加记录前后的数据操作。

<pre class="brush: php;">
class GuestbookModel extends Model
{
	protected $_primary = 'id';
	protected $_table = 'guestbook';

	/**
	 * 初始化模型
	 */
	protected function _model()
	{}

	protected function beforeCreate()
	{
		$this->create_time = time();
		echo 'create_time:' . $this->create_time . "|";
	}

	protected function afterCreate()
	{
		echo 'id:' . $this->id;
	}
}
</pre>
    （2）更新记录
	使用beforeUpdate()和afterUpdate()方法处理更新记录前后的数据操作。
	注：必须是通过select()或selectedFirst()方法选择记录然后使用save()或update()方法时才会生效。
	在afterUpdate()方法中，还可以使用hasChange()判断字段值是否修改。
	            <span class="STYLE3">hasChange([name])</span>
        参数说明：
</pre>
<table>
	<tr class="head">
		<td width="90">名称</td>
		<td width="400">描述</td>
	</tr>
	<tr>
		<td>name</td>
		<td>字段名称。</td>
	</tr>
</table>
</pre>
<pre>
	使用getOld()获取旧值。
</pre>
<pre>
	            <span class="STYLE3">getOld([name])</span>
        参数说明：

</pre>
<table>
	<tr class="head">
		<td width="90">名称</td>
		<td width="400">描述</td>
	</tr>
	<tr>
		<td>name</td>
		<td>字段名称。</td>
	</tr>
</table>
<pre>

</pre>
<pre class="brush: php;">
class GuestbookModel extends Model
{
	protected $_primary = 'id';
	protected $_table = 'guestbook';

	/**
	 * 初始化模型
	 */
	protected function _model()
	{}

	protected function beforeUpdate()
	{
		$this->update_time = time();
		echo 'update_time:' . $this->update_time . "|";
	}

	protected function afterUpdate()
	{
	    if ($this->hasChange('id')) {
			echo 'id旧值:' . $this->getOld('id');
			echo 'id新值:' . $this->id;
	   }
	}
}
</pre>
<pre>
    （3）删除记录
	使用beforeDelete()和afterDelete()方法处理删除记录前后的数据操作。
	注：必须是通过select()或selectedFirst()方法选择记录然后使用delete()方法时才会生效。

</pre>
<pre class="brush: php;">
class GuestbookModel extends Model
{
	protected $_primary = 'id';
	protected $_table = 'guestbook';

	/**
	 * 初始化模型
	 */
	protected function _model()
	{}

	protected function beforeDelete()
	{
		echo 'id:' . $this->id;
	}

	protected function afterDelete()
	{
	    //其他操作
	}
}
</pre>
</pre>
</body>
</html>
