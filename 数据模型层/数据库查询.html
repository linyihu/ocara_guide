<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>数据库查询</title>
<script type="text/javascript" src="../syntax/scripts/shCore.js"></script>
<script type="text/javascript" src="../syntax/scripts/shBrushPhp.js"></script>
<link type="text/css" rel="stylesheet" href="../style/base.css" />
<link type="text/css" rel="stylesheet" href="../syntax/styles/shCoreDefault.css"/>
<script type="text/javascript" src="../treeview/base.js"></script>
<style type="text/css">
<!--
.STYLE1 {
	color: #0000FF;
	font-weight: bold;
}
-->
</style>
</head>
<body>
<pre><h2>数据查询</h2>

<strong> 1、主键查询</strong>
       使用Model的select()方法通过主键选择一条记录：
            <span class="STYLE1">select([values, options, debug])</span>
       静态方法。返回的是模型类对象。
       参数说明：
</pre>
<table>
	<tr class="head">
		<td width="90">名称</td>
		<td width="400">描述</td>
	</tr>
	<tr>
		<td>values</td>
		<td>可选。主键值。如果是单字段主键，则直接传递该这字段值。如果是复合主键，以英文半解状态下的逗号“,”分隔。 
		</td>
	</tr>
	<tr>
		<td>options</td>
		<td>可选。查询选项。<br/>
		（1）如果是字符串，则表示字段列表。<br/>
		（2）如果是数组，其键名可以是小写的order、group、fields或limit，
		分别对应ORDER BY语句、GROUP BY语句、字段列表字符串和查询记录条数（Mysql中是limit语句）。
	    </td>
	</tr>
	<tr>
		<td>debug</td>
		<td>可选。用于SQL语句调试，默认为false或0。<br/>
		（1）值为false或0，不调试。默认值。<br/>
		（2）值为1时，不打印只会返回SQL语句，适合于将调试语句写到调试文件中。<br/>
		（3）值为2时，会停止代码执行而使用print_r打印SQL语句。<br/>
		（4）值为3时，会停止代码执行而使用var_dump打印SQL语句。
		</td>
	</tr>
</table>
<pre>

        实例如下：
        （1）查询主键id为1记录的username和email字段值
<pre class="brush: php;">
$userModel = \app\dal\models\User::select(1, 'username, email');
$result = $userModel->getData();
</pre>
        （2）查询detail表中的复合主键detail_id为1、line为2的记录
                 假设detailModel已设置属性$_primary为'detail_id,line'：
<pre class="brush: php;">
//查询结果
$result = \Model\Detail::select('1,2');
</pre>
        （3）按create_time降序排列，查询前100条记录的detail_id、line和price。
                 假设detailModel已设置属性$_primary为'detail_id,line'：
<pre class="brush: php;">
//查询选项
$option = array(
    'fields' => 'detail_id, line, price',
	'order'  => 'create_time DESC',
	'limit'  => '0,100'
);

//方式1.使用select()的参数
$result = \Model\Detail::select('1,2', $option)->getData();

//方式2.使用SQL查询的生成方法函数
$result = $detailModel->fields('detail_id, line, price')
    ->where(array(
		'detail_id' => 1,
		'line' 	    => 2
	))
   	->orderBy('create_time DESC')
	->limit(0, 100)
	->getAll();
</pre>

<strong>2、查询多条记录</strong>
     使用Model的getAll()或findAll方法可以查询多行记录：
            <span class="STYLE1">getAll([condition, option, debug])</span>
            <span class="STYLE1">findAll([condition, option, debug])</span>
     两者的区别是，getAll返回的数组中每个元素是记录数组或对象，而findAll返回的数组每个元素是记录的模型类实例。
     注：（1）一般地，没有分页时返回查询数据。
                  返回的是结果集数组，每条结果都是一个数组或对象，或实例。
                  如要是返回简单对象，要使用simple()方法：
                      <span class="STYLE1">simple()</span>
           （2）分页时，返回总数和查询数据。
                  如果使用了page()方法进行分页，则返回的数组只有total和data两个元素，total表示查询的总记录数，而data是查询数据，格式同上。
                  page()方法的使用请参见<a href="SQL语句生成.html">SQL语句生成函数page()</a>。

     参数说明：
	</pre>
<table>
	<tr class="head">
		<td width="90">名称</td>
		<td width="400">描述</td>
	</tr>
	<tr>
		<td>condition</td>
		<td>可选。更新条件。可以是字符串，也可以是键值数组。<br/>
		（1）如果为空，则取where()或cWhere()方法指定的条件。<br/>
		（2）如果没有使用where()或cWhere()指定条件，则会提示错误，因为更新数据必须有条件。<br/>
		（3）如果确实没有任何条件而需要更新所有记录，则使用where(1)即可。<br/>
		（4）该参数的格式与where()方法的用法一致。请查看<a href="SQL语句生成.html">SQL语句生成函数</a>中的where()的使用方法。				
		</td>
	</tr>
	<tr>
		<td>option</td>
		<td>可选。查询选项。同上。</td>
	</tr>
	<tr>
		<td>debug</td>
		<td>可选。调试参数，同上。
		</td>
	</tr>
</table>
<pre>

        实例如下：
（1）选择状态status为1并且按添加时间create_time降序排列的前10行记录的用户名和邮箱：
<pre class="brush: php;">
$fields= 'username, email';
$order = 'create_time DESC';
$limit = '1,10';
$where = array('status' => 1);

//方式1.使用getAll()参数
$userModel = new \app\dal\models\User();
$result = $userModel->getAll($where,
    array(
        'fields' => $fields,
        'order' => $order,
        'limit' => $limit
    )
);

//方式2.使用SQL查询的生成方法函数
$userModel = new \app\dal\models\User();
$result = $userModel->where($where)
     ->fields($fields)
	 ->orderBy($order)
	 ->limit($limit)
	 ->getAll(); //默认返回数组

//返回简单对象数组
$userModel = new \app\dal\models\User();
$result = $userModel->where($where)
     ->fields($fields)
	 ->orderBy($order)
	 ->limit($limit)
	 ->simple() //使用simple指定对象
	 ->findAll();

//返回模型实例数组
$userModel = new \app\dal\models\User();
$result = $userModel->where($where)
     ->fields($fields)
	 ->orderBy($order)
	 ->limit($limit)
	 ->findAll(); //使用findAll返回实例

</pre>
（2）统计不同状态status的男性用户(sex字段值为1)数量，使用where()设置条件
<pre class="brush: php;">$fields = '`status`, count(user_id) AS number';
$group = 'status';
$where = array('sex' => 1);

//方式1.使用getAll()的参数
$result = ocMode('user')->getAll($where,
     array(
	     'fields' => $fields,
	     'group' => $group
	 )
);

//方式2.使用查询函数
$userModel = new \app\dal\models\User();
$result = $userModel->where($where)
     ->fields($fields)
	 ->groupBy($group)
     ->getAll();

//返回对象数组
$userModel = new \app\dal\models\User();
$result = $userModel->where($where)
     ->fields($fields)
	 ->groupBy($group)
	 ->simple() //使用simple指定对象
     ->getAll();

//返回模型实例数组
$userModel = new \app\dal\models\User();
$result = $userModel->where($where)
     ->fields($fields)
	 ->groupBy($group)
     ->findAll(); //使用findAll返回实例
</pre>
<strong>3、查询一条记录</strong>
        使用Model的getRow()方法可以查询一条记录：
               <span class="STYLE1">getRow([condition，option, debug])</span>
               <span class="STYLE1">finRow([condition，option, debug])</span>
        两者的区别也是，getRow返回数组或对象，而finRow返回模型类实例。
        返回一条记录的关联数组或对象，默认为数组，同上主键查询。
        参数说明：
	</pre>
<table>
	<tr class="head">
		<td width="90">名称</td>
		<td width="400">描述</td>
	</tr>
	<tr>
		<td>condition</td>
		<td>可选。查询条件，同上。				
		</td>
	</tr>
	<tr>
		<td>option</td>
		<td>可选。查询选项，同上。
	    </td>
	</tr>
	<tr>
		<td>debug</td>
		<td>可选。调试参数，同上。
		</td>
	</tr>
</table>
<pre>

        实例如下：

（1）选择状态status为1最新用户（按添加时间create_time降序排列）的用户名和邮箱：
<pre class="brush: php;">
$fields= 'username, email';
$order = 'create_time DESC';
$where = array(
    'status' => 1
);

//方式1.使用getRow()的参数
$userModel = new \app\dal\models\User();
$result = $userModel->getRow($where,
    array(
	    'fields' => $fields,
		'order' => $order
    )
);

//方式2.使用SQL查询的生成方法函数
$userModel = new \app\dal\models\User();
$result = $userModel->where($where)
    ->fields($fields)
	->orderBy($order)
	->getRow();

//返回简单对象
$userModel = new \app\dal\models\User();
$result = $userModel->where($where)
    ->fields($fields)
	->orderBy($order)
	->simple() //返回对象
	->getRow();

//返回简单对象
$userModel = new \app\dal\models\User();
$result = $userModel->where($where)
    ->fields($fields)
	->orderBy($order)
	->findRow(); //返回实例
</pre>
（2）选择user_id为1用户的用户名和邮箱
<pre class="brush: php;">
$fields= 'username, email';
$where = array(
    'user_id' => 1
);

//查询结果-只指定字段列表时，第二个参数可以直接使用该字段列表字符串
$userModel = new \app\dal\models\User();
$result = $userModel->getRow($where, $fields);
</pre>
<strong>4、查询某个字段值</strong>
         使用Model的getValue(()方法可以按条件查询一条记录的某个字段的值：
                <span class="STYLE1">getValue((field, [condition, debug])</span>
         返回字段值，如果没有查到，则返回false。
         注：Limit语句请使用limit()方法。
         参数说明：
	</pre>
<table>
	<tr class="head">
		<td width="90">名称</td>
		<td width="400">描述</td>
	</tr>
	<tr>
		<td>field</td>
		<td>必需。字段名称。
	    </td>
	</tr>
	<tr>
		<td>condition</td>
		<td>可选。查询条件，同上。				
		</td>
	</tr>
	<tr>
		<td>debug</td>
		<td>可选。调试参数，同上。
		</td>
	</tr>
</table>
<pre>

<pre class="brush: php;">
$where = array(
    'user_id' => 1
);

//方式1.使用getValue(()的参数
$userModel = new \app\dal\models\User();
$result = $userModel->limit(1)->getValue(('username', $where);

//方式2.SQL查询的生成方法函数
$userModel = new \app\dal\models\User();
$result = $userModel->where($where)->limit(1)->getValue(('username');

</pre>


<strong>5、动态查询</strong>
     使用静态方法<span class="STYLE1">findBy+字段名、findRowBy+字段、getAllBy+字段名、getRowBy+字段名</span>可以按照某个字段进行查询。
<pre class="brush: php;">
//根据status查询多行（返回模型实例数组）
$result = User::findByStatus(2);

//根据user_id查询一行（返回模型实例）
$result = User::findRowByUserId(234);

//根据status查询多行（返回二维记录数组）
$result = User::getAllByStatus(2);

//根据user_id查询一行（返回一维记录数组）
$result = User::getRowByUserId(234);
</pre>

<strong>6、原生SQL查询</strong>
         使用Model的query()方法可以按条件查询一条记录的某个字段的值：
                <span class="STYLE1">query(sql, [debug])</span>
         成功时返回所有查询行的结果数组,每行结果是数组或者对象，如果没有查到，则返回false。
         参数说明：
	</pre>
<table>
	<tr class="head">
		<td width="90">名称</td>
		<td width="400">描述</td>
	</tr>
	<tr>
		<td>sql</td>
		<td>必需。原生SQL语句。
		</td>
	</tr>
	<tr>
		<td>debug</td>
		<td>可选。调试参数，同上。
		</td>
	</tr>
</table>
<pre>
         实例如下：
<pre class="brush: php;">
/*
 * 查询10行
 */
$userModel = new \app\dal\models\User();

//返回二维数组
$userModel->query('select * from user limit 10');

//返回对象数组
$userModel
	->simple()
	->query('select * from user');

</pre>

<strong>7、原生SQL查询一行</strong>
         使用Model的queryRow()方法可以按条件查询一条记录的某个字段的值：
                <span class="STYLE1">queryRow(sql, [debug])</span>
         成功时返回查询的那行数据关联数组或对象，如果没有查到，则返回false。
         参数同上。
         实例如下：
<pre class="brush: php;">
/*
 * 查询一行
 */
$userModel = new \app\dal\models\User();

//返回数组
$userModel->queryRow('select * from user');

//返回对象
$userModel
	->simple()
	->queryRow('select * from user');

</pre>

<strong>8、多表联接查询</strong>
     使用<span class="STYLE1">leftJoin()、rightJoin()或innerJoin()</span>分别进行左联接、右联接和全联接的查询。
<pre class="brush: php;">
//查询结果
$userModel = new \app\dal\models\User();
$result = $userModel->innerJoin('threads','b','a.user_id=b.user_id')//相当于INNER JOIN forum AS b ON a.user_id = b.user_id
    ->leftJoin('posts', 'c', 'b.tid=c.tid')		//相当于LEFT JOIN posts AS c ON b.tid = c.tid
    ->fields('b.title, b.content, a.username,a.email,c.content AS post_content')	//字段列表
    ->where('a.user_id=1 AND b.status=1') //查询条件
    ->limit('1,100')		//limit语句
    ->orderBy('c.create_time DESC') //排序
    ->getAll();
</pre>


<strong>9、合并查询（可分页）</strong>
	（1）合并查询函数
         使用union()和unionAll方法可以合并多个查询，只要主表上面使用该两个方法，传递Model对象为参数，格式如下:
                <span class="STYLE1">union(model) ｜ unionAll(model)</span>
         返回当前主表的Model对象，可用于连贯语句。
         注：两个方法可以多次使用，union()与unionAll()的区别在于，union()会去除重复数据。
         参数说明：
	</pre>
<table>
	<tr class="head">
		<td width="90">名称</td>
		<td width="400">描述</td>
	</tr>
	<tr>
		<td>model</td>
		<td>必需。数据模型类，必须是继承于框架的基本模型\Ocara\Model。
		</td>
	</tr>
</table>
<pre>

<pre class="brush: php;">
$userModel_1 = new \app\dal\models\User();
$userModel_1->fields('user_Id, user_name')
	->where(array('status' => 1))
	->limit('0, 10');

$userModel_2 = new \app\dal\models\User();
$userModel_2->fields('user_Id, user_name')
	->where(array('status' => 2))
	->limit('0, 10');

$model = new \app\modules\bbs\models\User(); //假设查询论坛bbs模块模型
$model->fields('uid as user_id, uname as user_name')
	->where('status' => 1)->limit('0, 5');

$result = $model->union($userModel_1)
	->unionAll($userModel_1)
	->getAll();

ocPrint($result);
</pre>

	（2）分页合并查询
	    （a）每个合并函数要进行分页
	    （b）最后查询时使用unionOrderBy()进行汇总排序。
	            <span class="STYLE1">unionOrderBy(orderBy)</span>
<table>
	<tr class="head">
		<td width="90">名称</td>
		<td width="400">描述</td>
	</tr>
	<tr>
		<td>orderBy</td>
		<td>必需。排序语句。
		</td>
	</tr>
</table>

	    （c）最后查询时使用unionLimit()进行汇总分页
	            <span class="STYLE1">unionLimit(offset[, $rows]</span>
<table>
	<tr class="head">
		<td width="90">名称</td>
		<td width="400">描述</td>
	</tr>
	<tr>
		<td>offset</td>
		<td>必需。查询开始位置。
		</td>
	</tr>
	<tr>
		<td>rows</td>
		<td>可选。查询行数。
		</td>
	</tr>
</table>

<pre class="brush: php;">
//分页设置
$pageInfo = $this->pager->getInfo();

//合并查询
$model->page($pageInfo);
$model->union($model);

$a = clone $model;
$a->limit(30);
$model->unionAll($a);

$b = clone $model;
$b->limit(20, 20);
$model->unionAll($b);

//汇总分页并查询
$result = $model
	->unionOrderBy('id dESC')
	->unionLimit($pageInfo['offset'], $pageInfo['rows'])
	->getAll();
</pre>


<strong>10、更多SQL查询语句的生成方法</strong>
     更多SQL语句生成函数，请点击进入<a href="SQL语句生成.html">SQL查询语句的生成</a>。
</pre>
</body></html>
