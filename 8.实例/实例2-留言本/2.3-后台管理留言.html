<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312" />
<title>2.3-后台管理留言</title>
<script type="text/javascript" src="../../syntax/scripts/shCore.js"></script>
<script type="text/javascript" src="../../syntax/scripts/shBrushPhp.js"></script>
<link type="text/css" rel="stylesheet" href="../../style/base.css" />
<link type="text/css" rel="stylesheet" href="../../syntax/styles/shCoreDefault.css"/>
<script type="text/javascript">SyntaxHighlighter.all();</script>
</head>
<body><pre><h2>2.3-后台管理留言</h2>

<strong>1、新建后台模块</strong>
      进入开发者中心，点击左边的模块（Module），在右边区域，添加名称为admin。后台的用户登录和权限控制，这里就不做了，权限控制很容易实现。
可以查看详细教程里面的权限控制一节。
  
<strong>2、新建留言管理控制器</strong>
      进入开发者中心，点击左边的控制器（Controller），在右边区域，控制器名称填写“admin/guestbook”，其他保持默认。

<strong>3、新建布局</strong>
      添加留言是在前台，使用的是layout.php作为布局文件。后台管理这里，要重新新建一个布局文件，我们定名为admin.php。
      只要在application/view/layout/admin.php文件。
      然后在admin模块文件中的__module()初始化函数中添加如下代码，修改layout：
<pre class="brush: php;">class AdminModule extends Controller
{
    /**
     * 初始化模块
     */
    public function __module()
    {
        $this->setLayout('admin');
    }
}
</pre>
  
<strong>4、查询并处理数据</strong>
      在indexAction中添加display()方法。
      注：这里的搜索条件是一个form_search的表单，因为该表单可以多次刷新使用不需要验表单，所以要加上checkForm(false)禁掉验证表单令牌。
      代码如下：
<pre class="brush: php;">
class IndexAction extends GuestbookController
{
	/**
	 * 初始化
	 */
	public function __action()
	{
		//搜索列表不需要验证表单
		$this->checkForm(false);
	}

	public function registerForms()
	{
		$this->form('form_search')->init(ocUrl('/admin/guestbook/index'));
	}

	public function display()
	{
		//新建Model
		//Model名称与控制器名称相同，可以直接使用$this->model()
		$model = $this->model();

		//手机号搜索条件
		if ($telphone = $this->request->getPost('telphone')) {
			$model->where(array(
				'telphone' => $telphone
			));
		}
		
		//分页设置
		$pager = $this->pager();
		$pageInfo = $pager->getInfo();
		
		//查询数据
		$result = $model->page($pageInfo)->getAll();

		$data 	= $result['data'];
		$total 	= $result['total'];
		
		$curRoute = $this->getRoute();
		$curGet   = $this->request->getGet();
		
		//生成分页HTML
		$pager->setHtml($total, array($curRoute, $curGet));
		
		//设置模板变量
		$this->assign(compact('pager', 'data'));
	}
}
</pre>

<strong>5、新建模板</strong>
      代码如下：
<pre class="brush: php;">
&lt;div class=&quot;search&quot;&gt;
&lt;?php echo $form_search->begin();?&gt;联系电话：
&lt;input type=&quot;text&quot; name=&quot;telphone&quot; /&gt;&amp;nbsp;
&lt;input type=&quot;submit&quot; name=&quot;Submit&quot; value=&quot;搜索&quot; /&gt;
&lt;?php echo $form_search->end();?&gt;
&lt;/div&gt;
&lt;table width=&quot;100%&quot; border=&quot;0&quot;&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;ID&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;联系手机&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;留言内容&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;操作&lt;/strong&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;?php foreach ($data as $row) {?&gt;
&lt;td&gt;&lt;?=$row['id']?&gt;&lt;/td&gt;
&lt;td&gt;&lt;?=$row['telphone']?&gt;&lt;/td&gt;
&lt;td&gt;&lt;?=$row['content']?&gt;&lt;/td&gt;
&lt;td&gt;&lt;a href=&quot;&lt;?=ocUrl('/admin/guestbook/index', array('id' => $row['id']))?&gt;&quot;&gt;删除&lt;/a&gt;&lt;/td&gt;
&lt;?php } ?&gt;
&lt;/tr&gt; 
&lt;tr&gt;
&lt;td colspan=&quot;4&quot; align=&quot;right&quot;&gt;&lt;?php echo $pager->html;?&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
</pre>
</pre>
</body>
</html>
